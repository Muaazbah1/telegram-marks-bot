# دليل تشغيل بوت علامات الطلاب التلقائي (الإصدار المحدث)

## نظرة عامة

هذا البوت مصمم لأتمتة عملية إرسال علامات الطلاب وتحليلها إحصائياً. تم تحديثه ليشمل خاصية **مراقبة قناة تليجرام** تلقائياً لملفات PDF.

**آلية العمل:**

1.  **مراقب القناة (`channel_monitor.py`):** يعمل كحساب مستخدم (User Account) يراقب القناة المحددة.
2.  **اكتشاف الملف:** عند نشر ملف PDF جديد في القناة، يقوم المراقب باكتشافه.
3.  **إعادة التوجيه:** يقوم المراقب بإعادة توجيه ملف PDF إلى البوت الرسمي.
4.  **البوت الرسمي (`bot.py`):** يستقبل الملف، ويقوم بتحليله، وإجراء التحليل الإحصائي، وإرسال النتائج الفردية للطلاب المسجلين، ونشر التقرير الإحصائي في القناة المحددة.

## المتطلبات الأساسية

1.  **حساب تليجرام:** لإنشاء البوت والقناة.
2.  **توكن البوت (Bot Token):** يتم الحصول عليه من @BotFather.
3.  **معرف المستخدم (User ID) الخاص بك:** لمعرفة معرفك كمشرف (يمكن الحصول عليه من بوتات مثل @userinfobot).
4.  **معرف القناة (Channel ID):** معرف القناة التي سيرسل إليها البوت النتائج الإحصائية (يجب أن يكون على شكل `-100xxxxxxxxxx`).
5.  **معرف API وهاش API (API ID & API Hash):** مطلوبان لتشغيل حساب المستخدم المبرمج (Pyrogram). يتم الحصول عليهما من موقع [my.telegram.org](https://my.telegram.org).

## خطوات التثبيت والتشغيل

### 1. إعداد البيئة وتثبيت المكتبات

يجب التأكد من تثبيت Python 3.11 أو أحدث.

```bash
# الانتقال إلى مجلد المشروع
cd telegram_marks_bot

# إنشاء بيئة افتراضية (موصى به)
python3.11 -m venv venv

# تفعيل البيئة الافتراضية
source venv/bin/activate

# تثبيت المكتبات المطلوبة (بما في ذلك Pyrogram)
pip install -r requirements.txt
```

### 2. إعداد ملف `config.py`

قم بفتح ملف `config.py` واملأ المتغيرات التالية بالقيم الصحيحة:

| المتغير | الوصف | مثال |
| :--- | :--- | :--- |
| `TELEGRAM_BOT_TOKEN` | التوكن الخاص بالبوت الذي حصلت عليه من @BotFather. | `"123456:ABC-DEF1234ghIkl-zyx57W2v1u123456"` |
| `ADMIN_IDS` | قائمة بمعرفات المستخدمين (Telegram IDs) المسموح لهم برفع ملفات العلامات (للاستخدام اليدوي للبوت). | `[123456789]` |
| `STATISTICS_OUTPUT_CHANNEL_ID` | معرف القناة التي سيرسل إليها البوت التقرير الإحصائي. **ملاحظة:** يجب أن يكون البوت مشرفاً في هذه القناة. | `-100123456789` |

### 3. إعداد ملف `channel_monitor.py`

هذا الملف هو المسؤول عن مراقبة القناة. قم بفتحه واملأ المتغيرات التالية:

| المتغير | الوصف | المصدر |
| :--- | :--- | :--- |
| `API_ID` | معرف API الخاص بك. | [my.telegram.org](https://my.telegram.org) |
| `API_HASH` | هاش API الخاص بك. | [my.telegram.org](https://my.telegram.org) |
| `BOT_USERNAME` | اسم المستخدم للبوت الرسمي (بدون @). | @BotFather |
| `CHANNEL_USERNAME` | اسم مستخدم القناة التي سيتم مراقبتها (مثال: `@Aleppo_Med_Marks`). | إعدادات القناة |

### 4. تشغيل البوت والمراقب (محلياً)

يجب تشغيل كلا الملفين في نفس الوقت. يفضل استخدام شاشتين طرفيتين (Terminal) منفصلتين أو استخدام أداة مثل `screen` أو `tmux` لتشغيلهما في الخلفية.

**أ. تشغيل البوت الرسمي (bot.py):**

```bash
# في الشاشة الطرفية الأولى
(venv) python bot.py
```

**ب. تشغيل مراقب القناة (channel_monitor.py):**

```bash
# في الشاشة الطرفية الثانية
(venv) python channel_monitor.py
```

### 5. النشر باستخدام Docker (موصى به لـ Koyeb)

للنشر على منصات مثل Koyeb، يفضل استخدام ملف `Dockerfile` المرفق، والذي يقوم بتشغيل البوت والمراقب معاً.

**خطوات النشر على Koyeb:**

1.  **إنشاء ملف الجلسة محلياً:**
    *   قم بتشغيل `python channel_monitor.py` محلياً مرة واحدة (كما في الخطوة 4) لإنشاء ملف الجلسة **`my_account.session`**.
    *   **هام جداً:** يجب عليك نسخ هذا الملف ورفعه إلى مستودع GitHub الخاص بك مع باقي ملفات المشروع.

2.  **النشر على Koyeb:**
    *   قم بربط Koyeb بمستودع GitHub الخاص بك.
    *   سيقوم Koyeb تلقائياً باكتشاف ملف `Dockerfile` وبناء التطبيق.
    *   **متغيرات البيئة:** تأكد من تعيين متغيرات البيئة التالية في إعدادات Koyeb:
        *   `TELEGRAM_BOT_TOKEN`
        *   `API_ID`
        *   `API_HASH`
        *   `BOT_USERNAME` (اسم المستخدم للبوت الرسمي)
        *   `CHANNEL_USERNAME` (اسم مستخدم القناة للمراقبة)

    *   **ملف `entrypoint.sh`:** يقوم هذا الملف بتشغيل `bot.py` في الخلفية و `channel_monitor.py` في المقدمة، مما يضمن استمرار عمل الحاوية ومراقبة القناة.

**ملاحظة هامة:** عند تشغيل `channel_monitor.py` لأول مرة، سيطلب منك إدخال رقم هاتفك ورمز التحقق الذي سيصلك على التليجرام. هذا لإنشاء ملف جلسة (Session File) باسم `my_account.session`، والذي سيسمح للبرنامج بالعمل كحسابك.

## كيفية استخدام البوت

### للطلاب (المستخدمين العاديين)

1.  **بدء التسجيل:** أرسل الأمر `/start`.
2.  **اختيار الجامعة والكلية:** اتبع التعليمات واختر "جامعة حلب" ثم "كلية الطب البشري".
3.  **إدخال الرقم الجامعي:** أرسل رقمك الجامعي (5 أرقام).
4.  **الحصول على العلامة:** بعد صدور العلامات، أرسل الأمر `/mark` للحصول على نتيجتك الفردية والتحليل الإحصائي الخاص بك.

### للمشرف (أنت)

1.  **نشر ملف العلامات:** قم بنشر ملف PDF الذي يحتوي على العلامات في القناة التي يراقبها `channel_monitor.py`.
2.  **المعالجة التلقائية:** سيقوم `channel_monitor.py` بإعادة توجيه الملف إلى `bot.py`، الذي سيقوم بتحميل الملف، تحليله، حفظ البيانات، إرسال التقرير الإحصائي إلى القناة المحددة، ثم إرسال النتائج الفردية لكل طالب مسجل.

## ملاحظات فنية هامة

*   **تحليل PDF:** تعتمد دالة `parse_pdf_marks` في ملف `pdf_parser.py` على افتراض أن الرقم الجامعي (5 أرقام) والعلامة موجودان في نفس السطر ويمكن استخراجهما بتعبير منتظم بسيط. **قد تحتاج إلى تعديل هذا التعبير المنتظم** ليتناسب مع التنسيق الدقيق لملفات PDF التي تستخدمها جامعتك.
*   **قاعدة البيانات:** يتم استخدام قاعدة بيانات SQLite بسيطة (`students_marks.db`) لتخزين بيانات التسجيل والعلامات.

## هيكل المشروع (المحدث لـ Docker)

```
telegram_marks_bot/
├── venv/                   # البيئة الافتراضية
├── bot.py                  # الكود الرئيسي لبوت التليجرام
├── channel_monitor.py      # كود مراقبة القناة وإعادة التوجيه (Pyrogram)
├── config.py               # ملف الإعدادات (التوكن، المعرفات، إلخ)
├── database.py             # كود التعامل مع قاعدة بيانات SQLite
├── pdf_parser.py           # كود تحليل ملفات PDF واستخراج العلامات
├── data_processor.py       # كود التحليل الإحصائي ورسم الرسوم البيانية
├── requirements.txt        # قائمة المكتبات المطلوبة
├── Dockerfile              # ملف بناء الحاوية (للنشر على Koyeb)
├── entrypoint.sh           # ملف تشغيل العمليات داخل الحاوية
└── README.md               # هذا الملف
```
