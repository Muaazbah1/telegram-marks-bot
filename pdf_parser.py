# pdf_parser.py
import fitz  # PyMuPDF
import re
import pandas as pd

def parse_pdf_marks(pdf_path):
    """
    يحلل ملف PDF ويستخرج العلامات على شكل قائمة من (الرقم الجامعي، العلامة).
    
    الافتراض: ملف PDF يحتوي على جدول يمكن استخراج النص منه،
    والعلامات مرتبة بشكل يمكن التعرف عليه، مثلاً:
    [الاسم] [الرقم الجامعي] [العلامة]
    
    **ملاحظة هامة:** هذه الدالة تحتاج إلى تعديل دقيق بناءً على شكل ملف PDF الفعلي.
    """
    
    doc = fitz.open(pdf_path)
    all_data = []
    
    # تعبير منتظم للبحث عن الرقم الجامعي (9 أرقام) والعلامة (رقم عشري أو صحيح)
    # هذا التعبير تقريبي ويجب تعديله ليتناسب مع شكل الجدول في ملف PDF
    # مثال: البحث عن 5 أرقام متبوعة بمسافة ثم رقم (العلامة)
    # regex = r"(\d{9})\s+([\d\.]+)"
    
    # بما أننا لا نعرف شكل الجدول، سنقوم باستخراج النص بالكامل ومحاولة تحليل الأسطر
    
    for page in doc:
        text = page.get_text()
        lines = text.split('\n')
        
        for line in lines:
            # محاولة استخراج الرقم الجامعي (9 أرقام) والعلامة (رقم عشري أو صحيح)
            # نفترض أن الرقم الجامعي يسبق العلامة في السطر
            # هذا التعبير يحاول العثور على 5 أرقام (الرقم الجامعي) متبوعة بأي شيء، ثم رقم عشري أو صحيح (العلامة)
            match = re.search(r"(\d{5}).*?([\d\.]+)", line)
            
            if match:
                student_id = match.group(1)
                mark_str = match.group(2)
                
                try:
                    mark = float(mark_str)
                    all_data.append((student_id, mark))
                except ValueError:
                    # تجاهل إذا لم يكن الرقم الثاني علامة صالحة
                    continue
    
    doc.close()
    
    # إزالة التكرارات إذا وجدت
    unique_data = list(set(all_data))
    
    return unique_data

if __name__ == '__main__':
    # مثال للاستخدام والاختبار: يتطلب ملف PDF تجريبي
    # بما أننا لا نملك ملف PDF تجريبي، سنكتفي بالدالة
    print("دالة تحليل PDF جاهزة. تحتاج إلى ملف PDF تجريبي للاختبار الفعلي.")
    
    # مثال على شكل البيانات المتوقع إرجاعها:
    # sample_data = [
    #     ("202012345", 85.5),
    #     ("202012346", 90.0),
    #     ...
    # ]
    # print(parse_pdf_marks("marks.pdf"))
    pass
